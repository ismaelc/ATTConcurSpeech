{"name":"Send expense to Concur using AT&T Speech","tagline":"A simple demo of an app that sends expense to Concur using voice captured by the AT&T Speech API","body":"## Sending expense to Concur with AT&T's Speech API\r\nThis code demonstrates how to submit business expense with voice using [AT&T's Speech Recognition API](http://developer.att.com/apis/speech) and the [Concur SDK](https://github.com/concur/concur-platform-sdk-js).  You can check out the demo video [here](https://www.youtube.com/watch?v=SR7ZqeG38ZM)\r\n\r\n<img src=\"https://jfqcza.bn1301.livefilestore.com/y2pAadkatL5OnCjt3D6gJvJz_-T2YbRGnxNv7gW-TWIxHufH0-PhJm8MpoTto1beuZLmE01iZ-PNNWz7z3JmQCvFBVkh8m2msnskbuXofQppGc/ConcurATTdiagram.PNG?psid=1\" width=\"800px\" />\r\n\r\nThe diagram above describes the flow of the demo, and the file/code where each logic is located.  The Code section below will explain how this all works. This code uses the HTML5 Audio API (use Chrome) to record voice, and node.js to drive the backend (primarily to accept client calls and call out web APIs). The AudioRecorder code is credited to Chris Wilson (check out his other demos [here](http://webaudiodemos.appspot.com/)).\r\n\r\n### Configuration\r\nYou would need to sign up for three developer accounts:\r\n\r\n- [Firebase](https://www.firebase.com/signup/) - Used to store/transfer the audio between the client and server\r\n- [AT&T Developer](https://developer.att.com/developer/flow/apiPlaygroundFlow.do?execution=e1s1) - Speech API to translate audio into text\r\n- [Concur Developer](https://developer.concur.com/register) - QuickExpense API to submit expense amount to Concur\r\n\r\nOnce you've signed up for all the three accounts above, you need to manually generate the access token for AT&T and Concur in the `config.js` file described below.  Follow these links on how to do that:\r\n\r\n- [Generate AT&T Developer access token](http://developer.att.com/apis/speech/docs)\r\n- [Generate Concur Developer access token](https://developer.concur.com/oauth-20/native-flow)\r\n\r\nFor Firebase, you simply need to add your Firebase URL that ends with `firebaseio.com`\r\n\r\n    config.att.accessToken = \"<insert AT&T access token here>\";\r\n    config.concur.accessToken = \"<insert Concur access token here>\";\r\n    config.firebase.url = \"<insert Firebase URL here>\";\r\n\r\n### Code\r\nPlease refer to the diagram at the top of this README to follow the code explanation below:\r\n\r\n1. Tap the microphone icon on the app to start recording voice. Tap it again to end recording.\r\n2. Capture voice into blob.  The function below will already hold the audio `blob`, ready to be sent Firebase\r\n             \r\n        function doneEncoding( blob ) {\r\n\t      // sendVoiceToNode called in concuratt.js\r\n\t      sendVoiceToNode(blob);\r\n          Recorder.setupDownload( blob, \"myRecording\" + ((recIndex<10)?\"0\":\"\") + recIndex + \".wav\" );\r\n          recIndex++;\r\n        }\r\n3. Trigger server to wait; Send B64'd blob to Firebase\r\n\r\n        // set up POST call as trigger to wait for Firebase to receive the B64 voice/binary file\r\n\t    var xhr = new XMLHttpRequest();\r\n\t    xhr.open(\"POST\", '/receiveVoice', true);\r\n\t    xhr.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');\r\n\r\n\t    // send the call to trigger server into wait mode\r\n\t    xhr.send(JSON.stringify(data));\r\n\r\n\t    // ... and send B64'd blob to Firebase\r\n\t    sendToFirebase(blob, id);\r\n4. Receive Base-64'd  blob from Firebase\r\n\r\n        // receive B64'd blob from Firebase\r\n        myVoiceRootRef.on('child_added', function(snapshot) {\r\n\t         if (!newVoiceItems) return; // Keep from loading entire list\r\n\r\n\t         var fbaseObj = snapshot.val();\r\n\r\n\t         var b64string = fbaseObj.voiceBlobBase64;\r\n\t         var buf = new Buffer(b64string, 'base64');\r\n\t         \r\n\t         ...\r\n\t    })\r\n\t    \r\n5. Call AT&T Speech API on voice blob\r\n\r\n\t    // set up call to AT&T Speech Recognition on blob turned to buffer\r\n\t    var headers = {\r\n\t\t   'Content-Type': 'audio/wav',\r\n\t\t   'Authorization': 'Bearer ' + config.att.accessToken,\r\n\t\t   'Accept' : 'application/json'\r\n\t    };\r\n\r\n\t    var options = {\r\n\t\t   host: 'api.att.com',\r\n\t\t   path: '/speech/v3/speechToText',\r\n\t\t   method: 'POST',\r\n\t\t   headers: headers\r\n        };\r\n\r\n \t    // Setup the request.\r\n\t    var req = https.request(options, function (res) {\r\n\t\t   res.setEncoding('utf-8');\r\n\r\n\t\t   var responseString = '';\r\n\r\n\t\t   res.on('data', function (data) {\r\n\t\t\t   responseString += data;\r\n\t\t   });\r\n\r\n\t\t   res.on('end', function () {\r\n\t\t\t   console.log(\"Response: \" + responseString);\r\n\t\t\t   ...\r\n\t\t    });\r\n\t\t});\r\n\t\t\r\n\t    req.on('error', function (e) {\r\n\t\t   // TODO: handle error.\r\n\t\t   console.log(e);\r\n\t    });\r\n\r\n\t    // make the request to AT&T Speech Recognition API\r\n\t    req.write(buf);\r\n\t    req.end();\t\t\r\n6. Send expense to Concur through QuickExpense API using the [Concur SDK](https://github.com/concur/concur-platform-sdk-js)\r\n       \r\n        // Upon confirmation from user, send amount to Concur\r\n        app.post('/receiveExpense', function(req, res) {\r\n\r\n\t      var amount = req.body.amount;\r\n\r\n          var now = new Date();\r\n          var year = now.getFullYear();\r\n\t      var month = now.getMonth();\r\n\t      var date = now.getDate();\r\n\r\n\t      var fullDate = year + '-' + (month +1) + '-' + date;\r\n\r\n\t      var concurBody = {\r\n\t\t    \"CurrencyCode\": \"USD\",\r\n\t\t    \"TransactionAmount\": amount,\r\n\t\t    \"TransactionDate\": fullDate\r\n\t      }\r\n\r\n\t      var options = {\r\n\t\t    oauthToken: config.concur.accessToken,\r\n\t\t    contentType:'application/json',\r\n\t\t    body:concurBody\r\n\t      }\r\n\r\n\t      concur.quickexpenses.send(options)\r\n\t       .then(function(data){\r\n\t\t      //Contains the ID and URI to the resource\r\n\t\t      console.log(\"QuickExpense created! \" + amount);\r\n\t\t      res.send(\"QuickExpense created! \" + amount);\r\n\t       })\r\n\t       .fail(function (error) {\r\n\t\t      //Error contains the error returned\r\n\t\t      console.log(error);\r\n\t       });\r\n        });\r\n\r\n### Support\r\nIf you have questions about this code, please contact me at chris.ismael@concur.com \r\n","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}